name: Deploy Website to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            echo "Starting Website deployment..."
            cd /home/appuser/appfaktory/website

            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            echo "Reloading Caddy..."
            sudo systemctl reload caddy

            echo "Website deployment completed!"

      - name: Verify deployment
        run: |
          echo "Verifying Website deployment..."
          sleep 5

          if curl -f -s -I https://easyagent.app-faktory.com > /dev/null 2>&1; then
            echo "Website is accessible at https://easyagent.app-faktory.com"
          else
            echo "Website health check pending"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Website Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://easyagent.app-faktory.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Deployment failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
