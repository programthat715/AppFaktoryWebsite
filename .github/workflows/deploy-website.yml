name: Deploy Website to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: programthat715/appfaktory-website

jobs:
  build-and-deploy:
    name: Build and Deploy to DigitalOcean
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: GITHUB_TOKEN
          script_stop: true
          script: |
            set -e
            echo "Starting Website container deployment..."
            cd /home/appuser/appfaktory/api

            echo "Logging into GHCR..."
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "Pulling latest image..."
            docker pull ghcr.io/programthat715/appfaktory-website:latest

            echo "Stopping existing container and cleaning up orphans..."
            docker compose -f docker-compose.digitalocean.yml down --remove-orphans website || true

            echo "Starting container..."
            docker compose -f docker-compose.digitalocean.yml up -d website

            echo "Cleaning up old images..."
            docker image prune -f

            echo "Website container deployment completed!"

      - name: Verify deployment
        run: |
          echo "Verifying Website deployment..."
          sleep 10

          if curl -f -s https://easyagent.app-faktory.com/health; then
            echo "Website health check passed!"
          else
            echo "Website health check pending - container may still be starting"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Website Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://easyagent.app-faktory.com" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Deployment failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
